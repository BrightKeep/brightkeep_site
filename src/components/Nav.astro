---
const isHome = Astro.url.pathname === '/' || Astro.url.pathname === '/index.html';
const navLinks = [
  { label: 'What We Do', href: '#what-we-do' },
  { label: 'How We Work', href: '#how-we-work' },
  { label: 'Services', href: '#services' },
  { label: 'Contact', href: '#contact' },
].map(link => ({
  ...link,
  href: isHome ? link.href : `/${link.href}`,
}));
const logoHref = isHome ? '#hero' : '/';
---

<nav
  id="main-nav"
  class="fixed top-0 left-0 right-0 z-50 bg-brand-primary/95 backdrop-blur-sm"
  aria-label="Main navigation"
>
  <div class="max-w-content mx-auto px-4 sm:px-6 lg:px-8 flex items-center justify-between h-16">
    <a
      href={logoHref}
      class="font-semibold text-lg text-white hover:text-brand-accent transition-colors duration-200 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-white rounded"
      data-nav-link
    >
      BrightKeep
    </a>

    {/* Desktop links */}
    <ul class="hidden md:flex items-center gap-8" id="desktop-nav-links">
      {navLinks.map((link) => (
        <li>
          <a
            href={link.href}
            class="nav-link text-small text-white/80 hover:text-white transition-colors duration-200 py-2 relative focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-white rounded"
            data-nav-link
          >
            {link.label}
          </a>
        </li>
      ))}
    </ul>

    {/* Mobile hamburger button */}
    <button
      id="mobile-menu-toggle"
      class="md:hidden min-w-[44px] min-h-[44px] inline-flex items-center justify-center relative focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-white rounded"
      type="button"
      aria-expanded="false"
      aria-controls="mobile-menu"
      aria-label="Toggle navigation menu"
    >
      <span class="hamburger-line block w-6 h-0.5 bg-white absolute transition-all duration-300 -translate-y-1.5" aria-hidden="true"></span>
      <span class="hamburger-line block w-6 h-0.5 bg-white absolute transition-all duration-300" aria-hidden="true"></span>
      <span class="hamburger-line block w-6 h-0.5 bg-white absolute transition-all duration-300 translate-y-1.5" aria-hidden="true"></span>
    </button>
  </div>

  {/* Mobile menu dropdown */}
  <div
    id="mobile-menu"
    class="md:hidden overflow-hidden bg-brand-primary border-t border-white/10"
    style="max-height: 0;"
  >
    <ul class="px-4 py-2 space-y-1">
      {navLinks.map((link) => (
        <li>
          <a
            href={link.href}
            class="mobile-nav-link nav-link block py-3 px-4 text-body text-white/80 hover:text-white hover:bg-white/10 rounded-lg transition-colors duration-200 min-h-[44px] flex items-center focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-white"
            data-nav-link
          >
            {link.label}
          </a>
        </li>
      ))}
    </ul>
  </div>
</nav>

<style>
  /* Active nav link indicator */
  #desktop-nav-links .nav-link.active {
    color: #FF6B6B;
  }
  #desktop-nav-links .nav-link.active::after {
    content: '';
    position: absolute;
    bottom: -2px;
    left: 0;
    right: 0;
    height: 2px;
    background-color: #FF6B6B;
    border-radius: 1px;
  }
  .mobile-nav-link.active {
    color: #FF6B6B;
    background-color: rgba(255, 255, 255, 0.1);
  }

  /* Hamburger -> X transition */
  [aria-expanded="true"] .hamburger-line:first-child {
    transform: translateY(0) rotate(45deg);
  }
  [aria-expanded="true"] .hamburger-line:nth-child(2) {
    opacity: 0;
  }
  [aria-expanded="true"] .hamburger-line:last-child {
    transform: translateY(0) rotate(-45deg);
  }

  @media (prefers-reduced-motion: reduce) {
    .hamburger-line,
    #mobile-menu {
      transition: none !important;
    }
  }
</style>

<script>
  import { gsap } from 'gsap';
  import { ScrollTrigger } from 'gsap/ScrollTrigger';
  import { ScrollToPlugin } from 'gsap/ScrollToPlugin';

  gsap.registerPlugin(ScrollTrigger, ScrollToPlugin);

  const NAV_HEIGHT = 64;
  const prefersReducedMotion = window.matchMedia(
    '(prefers-reduced-motion: reduce)'
  ).matches;
  const toggleBtn = document.getElementById('mobile-menu-toggle');
  const mobileMenu = document.getElementById('mobile-menu');

  // --- Mobile menu ---
  function closeMobileMenu() {
    if (!toggleBtn || !mobileMenu) return;
    if (toggleBtn.getAttribute('aria-expanded') !== 'true') return;
    toggleBtn.setAttribute('aria-expanded', 'false');
    if (prefersReducedMotion) {
      mobileMenu.style.maxHeight = '0';
    } else {
      gsap.to(mobileMenu, { maxHeight: 0, duration: 0.25, ease: 'power2.in' });
    }
  }

  function openMobileMenu() {
    if (!toggleBtn || !mobileMenu) return;
    toggleBtn.setAttribute('aria-expanded', 'true');
    const height = mobileMenu.scrollHeight;
    if (prefersReducedMotion) {
      mobileMenu.style.maxHeight = height + 'px';
    } else {
      gsap.to(mobileMenu, {
        maxHeight: height,
        duration: 0.3,
        ease: 'power2.out',
      });
    }
  }

  toggleBtn?.addEventListener('click', (e) => {
    e.stopPropagation();
    if (toggleBtn.getAttribute('aria-expanded') === 'true') {
      closeMobileMenu();
    } else {
      openMobileMenu();
    }
  });

  // Close on outside click
  document.addEventListener('click', (e) => {
    if (toggleBtn?.getAttribute('aria-expanded') !== 'true') return;
    const nav = document.getElementById('main-nav');
    if (nav && !nav.contains(e.target as Node)) closeMobileMenu();
  });

  // Close on Escape key
  document.addEventListener('keydown', (e) => {
    if (
      e.key === 'Escape' &&
      toggleBtn?.getAttribute('aria-expanded') === 'true'
    ) {
      closeMobileMenu();
      toggleBtn?.focus();
    }
  });

  // Close on desktop resize
  window
    .matchMedia('(min-width: 768px)')
    .addEventListener('change', (e) => {
      if (e.matches) closeMobileMenu();
    });

  // --- Smooth scroll on nav link clicks (only for hash links on same page) ---
  document.querySelectorAll('[data-nav-link]').forEach((link) => {
    link.addEventListener('click', (e) => {
      const href = (link as HTMLAnchorElement).getAttribute('href');
      if (!href?.startsWith('#')) return;
      const target = document.querySelector(href) as HTMLElement | null;
      if (!target) return;

      e.preventDefault();
      closeMobileMenu();

      if (prefersReducedMotion) {
        window.scrollTo({
          top: target.offsetTop - NAV_HEIGHT,
          behavior: 'instant' as ScrollBehavior,
        });
      } else {
        gsap.to(window, {
          duration: 0.8,
          scrollTo: { y: target, offsetY: NAV_HEIGHT },
          ease: 'power2.inOut',
        });
      }
    });
  });

  // --- Active section highlighting via ScrollTrigger ---
  const sectionIds = [
    'hero',
    'what-we-do',
    'how-we-work',
    'services',
    'contact',
  ];

  function setActiveLink(id: string) {
    document.querySelectorAll('[data-nav-link]').forEach((link) => {
      const href = (link as HTMLAnchorElement).getAttribute('href');
      link.classList.toggle('active', href === `#${id}` || href === `/#${id}`);
    });
  }

  sectionIds.forEach((id) => {
    const el = document.getElementById(id);
    if (!el) return;
    ScrollTrigger.create({
      trigger: el,
      start: `top ${NAV_HEIGHT + 100}px`,
      end: 'bottom center',
      onEnter: () => setActiveLink(id),
      onEnterBack: () => setActiveLink(id),
    });
  });

  // --- Handle URL hash on page load ---
  if (window.location.hash) {
    const target = document.querySelector(
      window.location.hash
    ) as HTMLElement | null;
    if (target) {
      requestAnimationFrame(() => {
        window.scrollTo({
          top: target.offsetTop - NAV_HEIGHT,
          behavior: 'instant' as ScrollBehavior,
        });
        setActiveLink(window.location.hash.slice(1));
      });
    }
  }
</script>
